###################################
# Generated by confd {{datetime}} #
#             #######             #
#             # k3d #             #
#             #######             #
###################################

error_log stderr notice;

worker_processes auto;
events {
  multi_accept on;
  use epoll;
  worker_connections 1030;
}

stream {

  {{ range gets "/ports/*" }}

  {{- $port := index (split .Key "/") 2 -}}

  {{- $targetHost := index (split .Value ":") 0 -}}
  {{- $targetPort := index (split .Value ":") 1 -}}

  upstream {{ $targetHost }} {
    server {{ $targetHost }}:{{ $targetPort }} max_fails=1 fail_timeout=10s;
  }

  server {
    listen        {{ $port }};
    proxy_pass    {{ $targetHost }};
    proxy_timeout 600;
    proxy_connect_timeout 2s;
  }
    
  {{ end }}
}